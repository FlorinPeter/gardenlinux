#!/usr/bin/env bash
set -Eexuo pipefail

. $(dirname $0)/.helper

# preselect media-types
sudo apt-get install -y media-types
sudo apt-get remove -y git # yeah... no idea why, but python3.9 has `Build-Conflicts: git` set, so remove before build ¯\_(ツ)_/¯
apt-get source $src

cd $src-*/
patch -p1 < $srcDir/libdb.patch
patch -p1 < $srcDir/testsuite.patch
dch -lgardenlinux 'remove libdb'
dch -a 'parse error on test for libpython3.9-testsuite fixed'
dch -r ''
debian/rules control-file

install_build_deps
donotmove="$(ls ..)"
DEB_BUILD_OPTIONS="nocheck nopgo ${DEB_BUILD_OPTIONS:-}" build
link_version
move_package .. $donotmove
