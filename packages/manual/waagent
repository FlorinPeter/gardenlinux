#!/usr/bin/env bash
set -Eexuo pipefail

. $(dirname $0)/.helper

if [ "$ARCH" != "$(dpkg --print-architecture)" ]; then
	echo "$src builds architecture all packages only, so no cross arch build needed."
	exit 0
fi

#TODO switch this to waagent-old and build latest 2.3 version as well
VERSION="2.2.47-2"

sudo apt-get update
sudo apt-get install -y debian-keyring quilt
dget -x http://ftp.debian.org/debian/pool/main/w/waagent/waagent_${VERSION}.dsc

cd $src-*/
quilt import $srcDir/networkctl
quilt import $srcDir/tobytes
quilt push -a
dch -lgardenlinux 'remove tostring() methods for python3.9 / switch ifup/down to networkctl reconfigure'
dch -r ''

install_build_deps
donotmove="$(ls ..)"
build
link_version
move_package .. $donotmove
