#!/usr/bin/env bash 

apt-mark hold linux-image-cloud-amd64

# set default umask to a more conservative value
sed -i 's/UMASK\t\t022/UMASK\t\t027/' /etc/login.defs
#cat <<EOF >>/etc/pam.d/common-session
# Allow umask to be changed
#session optional pam_umask.so
#EOF

DEBIAN_FRONTEND=noninteractive pam-auth-update --remove cracklib
rm -f /usr/share/pam-configs/cracklib
DEBIAN_FRONTEND=noninteractive pam-auth-update

for kernel in /boot/vmlinuz-*; do 
   dracut -f /boot/initrd.img-${kernel#*-} ${kernel#*-} -m "bash dash systemd systemd-initrd kernel-modules kernel-modules-extra terminfo udev-rules dracut-systemd gardenlinux base fs-lib shutdown" --reproducible
   /usr/bin/kernel-install add "${kernel#*-}" "${kernel}" "/boot/initrd.img-${kernel#*-}"
done

#V: 5.10.0-8-amd64
#K: /boot/vmlinuz-5.10.0-8-amd64
#I: /boot/initrd.img-5.10.0-8-amd64

# bootloader
mkdir /boot/efi/syslinux
cp /usr/lib/syslinux/modules/bios/menu.c32 /boot/efi/syslinux/ 
cp /usr/lib/syslinux/modules/bios/libutil.c32 /boot/efi/syslinux/ 
rm -f /boot/efi/Default/blank

update-syslinux
