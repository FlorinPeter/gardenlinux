#!/bin/bash

# Install new docker, containerd, and runc packages that are known to work
#
downloads="http://snapshot.debian.org/archive/debian/20210409T032703Z/pool/main/d/docker.io/docker.io_20.10.5%2Bdfsg1-1%2Bb1_amd64.deb http://snapshot.debian.org/archive/debian/20210519T212015Z/pool/main/r/runc/runc_1.0.0~rc93%2Bds1-5_amd64.deb http://snapshot.debian.org/archive/debian/20210313T203823Z/pool/main/c/containerd/containerd_1.4.4~ds1-2_amd64.deb"

mkdir -p /tmp/gardener-updates
for package in $downloads; do
    wget --quiet -P /tmp/gardener-updates $package
done

apt-get install -y -f /tmp/gardener-updates/*
rm -rf /tmp/gardener-updates

# set the default to iptalbes and deactivate nf_tables kernel modules
#
update-alternatives --set iptables /usr/sbin/iptables-legacy
update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
update-alternatives --set arptables /usr/sbin/arptables-legacy
update-alternatives --set ebtables /usr/sbin/ebtables-legacy

# just to make sure there are no traces left
#
systemctl mask nftables.service

# Disable docker and containerd, Gardener will have to enable the
# one it uses
#
systemctl disable docker
systemctl disable containerd
