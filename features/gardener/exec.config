#!/bin/bash

# Install new docker.io version with new runc package
wget --quiet http://ftp.de.debian.org/debian/pool/main/d/docker.io/docker.io_20.10.5+dfsg1-1+b1_amd64.deb -O /tmp/docker.io_20.10.5+dfsg1-1+b1_amd64.deb
apt-get install -y -f /tmp/docker.io_20.10.5+dfsg1-1+b1_amd64.deb
rm /tmp/docker.io_20.10.5+dfsg1-1+b1_amd64.deb

wget --quiet http://ftp.de.debian.org/debian/pool/main/c/containerd/containerd_1.4.4~ds1-2_amd64.deb -O /tmp/containerd_1.4.4~ds1-2_amd64.deb
apt-get install -y -f /tmp/containerd_1.4.4~ds1-2_amd64.deb
rm /tmp/containerd_1.4.4~ds1-2_amd64.deb

wget --quiet http://ftp.de.debian.org/debian/pool/main/r/runc/runc_1.0.0~rc93+ds1-5_amd64.deb -O /tmp/runc_1.0.0~rc93+ds1-5_amd64.deb
apt-get install -y -f /tmp/runc_1.0.0~rc93+ds1-5_amd64.deb
rm /tmp/runc_1.0.0~rc93+ds1-5_amd64.deb

# set the default to iptalbes and deactivate nf_tables kernel modules
#
update-alternatives --set iptables /usr/sbin/iptables-legacy
update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
update-alternatives --set arptables /usr/sbin/arptables-legacy
update-alternatives --set ebtables /usr/sbin/ebtables-legacy

# just to make sure there are no traces left
#
systemctl mask nftables.service

# Disable docker and containerd, Gardener will have to enable the
# one it uses
#
systemctl disable docker
systemctl disable containerd
