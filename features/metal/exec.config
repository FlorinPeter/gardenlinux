systemctl enable haveged
systemctl enable ipmievd

update-kernel-cmdline

mkdir -p /boot/efi/EFI/BOOT

case $(dpkg --print-architecture) in
   amd64) uefi_arch=X64;;
   arm64) uefi_arch=AA64;;
   *) echo "Unknown arch"; exit 1;;
esac

for kernel in /boot/vmlinuz-*; do
   #legacy
   dracut\
   --force\
   --kver "${kernel#*-}"\
   --modules "bash dash systemd systemd-initrd kernel-modules kernel-modules-extra terminfo udev-rules dracut-systemd gardenlinux base fs-lib shutdown"\
   --reproducible\
   "/boot/initrd.img-${kernel#*-}"

   #uefi
   dracut\
   --force\
   --kver "${kernel#*-}"\
   --uefi\
   --modules "bash dash systemd systemd-initrd kernel-modules kernel-modules-extra terminfo udev-rules dracut-systemd gardenlinux base fs-lib shutdown"\
   --kernel-cmdline "$(cat /etc/kernel/cmdline)"\
   --reproducible\
   "/boot/efi/EFI/BOOT/BOOT${uefi_arch}.EFI"
done

rm -f /etc/dracut.conf.d/30-secureboot.conf

if [ -f "/usr/bin/syslinux" ]; then
   # bootloader
   mkdir -p /boot/efi/syslinux
   cp /usr/lib/syslinux/modules/bios/menu.c32 /boot/efi/syslinux/
   cp /usr/lib/syslinux/modules/bios/libutil.c32 /boot/efi/syslinux/

   update-syslinux
fi
